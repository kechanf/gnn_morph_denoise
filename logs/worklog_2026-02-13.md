# 工作日志（2026-02-13）

记录时间：2026-02-13 00:30:42

## 今日目标
- 在 morphology 数据上打通并验证两阶段流程（阶段1生成预训练 + 阶段2节点分类）。
- 在完整数据集上分析并尝试提升节点分类 acc。

## 已完成事项

### 1) 两阶段流程打通与修复
- 修复阶段1 checkpoint 不落盘问题：
  - `external/DiGress/src/main.py`：对两阶段 run 强制启用 checkpoint，并在训练结束后显式保存 `last.ckpt`。
  - `external/DiGress/src/utils.py`：为两阶段 run 预建固定 checkpoint 目录。
- 修复阶段2配置问题：
  - `scripts/run_two_stage_tiny50.sh`：`model.encoder_ckpt` 改为 `+model.encoder_ckpt`（Hydra struct 模式兼容）。
- 修复阶段2数据维度问题：
  - `train_node_classifier.py` 补充 `dataset_infos.compute_input_output_dims(...)`。
  - `models/node_classifier.py` 兼容 morphology 的 `data.y` 空维度。
  - `models/transformer_model.py` 新增 `forward_node_embedding()`，阶段2使用隐藏表示而非输出维度。

### 2) 运行结果
- tiny50 两阶段：已跑通（阶段1、阶段2均完成）。
- 完整数据 + normal_24g：阶段1 OOM，失败（无可用 ckpt）。
- 完整数据 + debug 模型：两阶段跑通。
  - 基线（full + debug）阶段2 best：
    - `val/acc = 0.6774`
    - `val/precision = 0.5456`
    - `val/recall = 0.3173`

### 3) 提升 acc 的实验与结论
- 方案 v1（动态 `pos_weight` + `threshold=0.35` + freeze）：
  - 退化为接近全正类预测，`val/acc` 约 0.3407，失败。
- 方案 v2（固定全局 `pos_weight=1.7693` + `threshold=0.5` + freeze）：
  - 召回提升但 acc 下降，best `val/acc = 0.6616`，不如基线。
- 当前判断：
  - 对“提升 acc”目标，`pos_weight` 路线在当前设置下不优。

### 4) 当前在跑实验
- freeze-only（只加 `freeze_encoder_epochs=3`，不加 `pos_weight`）已启动：
  - run 名：`node_cls_morphology_full_two_stage_freeze_only_v1`
  - 截止记录时尚未进入 val 轮，仍在训练中。

## 关键产物路径
- 阶段1（full）checkpoint：
  - `external/DiGress/checkpoints/morph_full_two_stage/`
- 基线阶段2（full + debug）输出：
  - `external/outputs/2026-02-12/15-34-54-node_cls_morphology_full_two_stage/`
- v2（固定 pos_weight）输出：
  - `external/outputs/2026-02-12/20-22-31-node_cls_morphology_full_two_stage_minimal_v2/`
- freeze-only（进行中）输出：
  - `external/outputs/2026-02-13/00-14-32-node_cls_morphology_full_two_stage_freeze_only_v1/`

## 下一步建议
- 等待 freeze-only 跑完，优先对比其 `best val/acc` 是否超过基线 0.6774。
- 若 freeze-only 仍不提升 acc，可继续做：
  - 仅调学习率/训练轮数（不改损失）；
  - 固定阈值 0.5 下做更细粒度 early-stop/选最优 epoch。
